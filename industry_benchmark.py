"""MRARFAI Industry Benchmark Module"""

HMD_REASONS = [
    'HMD全球出货同比-21%,但禾苗降幅-42%远超行业,禾苗在HMD丢了份额',
    'HMD功能机产品线缩减,直接影响禾苗CKD/FP核心订单',
    '部分型号可能被华勤以规模成本优势抢走',
    'HMD自有品牌转型,减少ODM依赖',
]

class IndustryBenchmark:
    def __init__(self, data, results):
        self.d = data
        self.r = results

    def run(self):
        return {
            '市场定位': self._positioning(),
            '客户外部视角': self._client_views(),
            '竞争对标': self._competitive(),
            '结构性风险': self._risks(),
            '战略机会': self._opportunities(),
        }

    def _positioning(self):
        rev = self.d['总营收'] / 10000
        return {
            '禾苗营收': '%.1f亿' % rev,
            '行业位次': '第4梯队(华勤920亿>闻泰615亿>龙旗560亿>>禾苗%.1f亿)' % rev,
            '规模差距': '仅为华勤的%.1f%%' % (rev / 920 * 100),
            '差异化优势': '毛利率9.5%(行业均值7.5%),聚焦中低端+功能机利基市场',
            '增速': '+54.1%(华勤+28%,龙旗+22%,闻泰+5%) 增速领先但基数最小',
        }

    def _client_views(self):
        views = []
        hmd = next((c for c in self.d.get('类别YoY', []) if c['类别'] == 'HMD'), None)
        if hmd:
            r = hmd['增长率']
            views.append({
                '客户': 'HMD',
                '外部': 'HMD全球出货同比-21%(28M->22M台)',
                '禾苗': '%+.1f%%' % (r * 100),
                '判断': '禾苗降幅(%.0f%%)远超HMD整体(-21%%)->在HMD供应商中丢失了份额' % (r * 100),
                '根因': '; '.join(HMD_REASONS),
            })
        zte = next((c for c in self.d.get('类别YoY', []) if c['类别'] == 'ZTE'), None)
        if zte:
            r = zte['增长率']
            views.append({
                '客户': 'ZTE',
                '外部': 'ZTE消费者业务+15%,海外扩张中',
                '禾苗': '+%.1f%%' % (r * 100),
                '判断': '禾苗增速(+%.0f%%)高于ZTE整体(+15%%)->份额在提升' % (r * 100),
            })
        views.append({
            '客户': 'LAVA',
            '外部': 'Lava出货+12%,印度PLI政策利好CKD',
            '判断': '印度CKD需求增长,Lava智能机上攻可能带来更多高价值SP订单',
        })
        return views

    def _competitive(self):
        rev = self.d['总营收'] / 10000
        top3 = self.r['客户分级'][2]['累计占比'] if len(self.r['客户分级']) > 2 else 0
        return {
            '营收': {'华勤': 920, '闻泰': 615, '龙旗': 560, '禾苗': round(rev, 1)},
            '增速': {'禾苗': '+54.1%', '华勤': '+28%', '龙旗': '+22%', '闻泰': '+5%'},
            '毛利率': {'禾苗': '9.5%', '闻泰': '8.2%', '均值': '7.5%', '龙旗': '7.1%', '华勤': '6.8%'},
            '客户集中度': 'Top3占%s%%(行业健康线<50%%) 远超安全线' % top3,
        }

    def _risks(self):
        return [
            {'风险': '功能机结构性萎缩', '行业': '全球功能机年萎缩约15%',
             '禾苗': 'HMD(最大FP客户)下滑42%,功能机是传统核心',
             '建议': 'FP维持利润贡献但不应追加投入,加速SP/平板/IoT转型'},
            {'风险': '印度市场过度依赖', '行业': '印度智能机仅+4%,功能机-19%',
             '禾苗': '印度占出货61.7%(HHI=4120)',
             '建议': '中东/拉美/非洲作为分散化重点,降低单一市场暴露'},
            {'风险': 'HMD客户持续流失', '行业': 'HMD全球-21%,Nokia授权不确定',
             '禾苗': '禾苗降幅-42%超行业,正在丢份额给华勤/富士康',
             '建议': '稳固现有型号同时降低HMD营收预期,2026年HMD可能继续缩减'},
            {'风险': '客户集中度过高', '行业': 'ODM行业Top3客户占比通常40-50%',
             '禾苗': 'Top3占61%,Top4占68.5%',
             '建议': '积极拓展中型客户(5000-15000万元级),分散风险'},
        ]

    def _opportunities(self):
        return [
            {'机会': '平板业务战略升级', '数据': '平板+110.4%,ZYB占比24.2%',
             '行业': '全球平板+3.7%,教育/AI平板需求增长',
             '行动': '将平板定位为第二增长曲线,拓展教育平板/AI学习机品类'},
            {'机会': '深化ZTE合作', '数据': 'ZTE业务+42%,份额在提升',
             '行业': 'ZTE海外中低端加速扩张',
             '行动': '争取成为ZTE海外核心ODM,锁定2-3年框架协议'},
            {'机会': 'AIOT新品类扩展', '数据': 'Others AIOT +352.7%',
             '行业': '华勤龙旗均重点布局IoT/智能家居',
             '行动': '选1-2个垂直品类深耕(AI学习机/智能POS/IoT网关)'},
            {'机会': '印度CKD政策红利', '数据': 'CKD占出货61.9%',
             '行业': 'PLI政策推动本地组装',
             '行动': '考虑在印度设立/扩大组装支持,强化与Lava等印度品牌合作'},
        ]


def generate_benchmark_section(results):
    b = results
    s = "---\n## 附一、行业基准对标\n\n"
    s += "### 1. 禾苗在ODM行业的位置\n\n"
    for k, v in b['市场定位'].items():
        s += "- **%s**: %s\n" % (k, v)

    cb = b['竞争对标']
    s += "\n### 2. 竞争对标\n\n"
    s += "| 公司 | 营收(亿) | 增速 | 毛利率 |\n|------|---------|------|--------|\n"
    for name in ['华勤', '闻泰', '龙旗', '禾苗']:
        marker = ' <-' if name == '禾苗' else ''
        s += "| %s%s | %s | %s | %s |\n" % (
            name, marker, cb['营收'].get(name, '-'),
            cb['增速'].get(name, '-'), cb['毛利率'].get(name, '-'))
    s += "\n**客户集中度**: %s\n\n" % cb['客户集中度']

    s += "### 3. 核心客户外部情报\n\n"
    for v in b['客户外部视角']:
        s += "**%s**\n\n" % v['客户']
        if '外部' in v:
            s += "- 外部趋势: %s\n" % v['外部']
        if '禾苗' in v:
            s += "- 禾苗表现: %s\n" % v['禾苗']
        s += "- **判断: %s**\n" % v['判断']
        if '根因' in v:
            s += "- 根因分析: %s\n" % v['根因']
        s += "\n"

    s += "### 4. 结构性风险\n\n"
    for r in b['结构性风险']:
        s += "**[风险] %s**\n- 行业: %s | 禾苗: %s\n- -> %s\n\n" % (
            r['风险'], r['行业'], r['禾苗'], r['建议'])

    s += "### 5. 战略增长机会\n\n"
    for i, o in enumerate(b['战略机会'], 1):
        s += "**%d. %s** (%s)\n- 行业: %s\n- -> %s\n\n" % (
            i, o['机会'], o['数据'], o['行业'], o['行动'])
    return s
